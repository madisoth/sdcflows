<!doctype html>
<html class="no-js">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />
<link rel="index" title="Index" href="../genindex.html" /><link rel="search" title="Search" href="../search.html" /><link rel="next" title="sdcflows.workflows.fit.pepolar module" href="sdcflows.workflows.fit.pepolar.html" /><link rel="prev" title="sdcflows.workflows.fit package" href="sdcflows.workflows.fit.html" />

    <meta name="generator" content="sphinx-4.2.0, furo 2021.10.09"/>
        <title>sdcflows.workflows.fit.fieldmap module - sdcflows 2.0.8 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?digest=0254c309f5cadf746f1a613e7677379ac9c8cdcd" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?digest=16fb25fabf47304eee183a5e9af80b1ba98259b1" />
    <link rel="stylesheet" type="text/css" href="../_static/css/version-switch.css" />
    
    


<style>
  body {
    --color-code-background: #f8f8f8;
  --color-code-foreground: black;
  
  }
  body[data-theme="dark"] {
    --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
  }
  @media (prefers-color-scheme: dark) {
    body:not([data-theme="light"]) {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
  }
</style></head>
  <body>
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
      <path stroke="none" d="M0 0h24v24H0z" />
      <line x1="4" y1="6" x2="20" y2="6" />
      <line x1="10" y1="12" x2="20" y2="12" />
      <line x1="6" y1="18" x2="20" y2="18" />
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-half" viewBox="0 0 24 24">
    <title>Auto light/dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-shadow">
      <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
      <circle cx="12" cy="12" r="9" />
      <path d="M13 12h5" />
      <path d="M13 15h4" />
      <path d="M13 18h1" />
      <path d="M13 9h4" />
      <path d="M13 6h1" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">sdcflows 2.0.8 documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
    <span class="sidebar-brand-text">sdcflows</span>
    <span id="version-slug" class="sidebar-brand-text">2.0.8</span>
</a>

<!-- Versions dropdown -->
<div id="version-menu" class="version-tree">
  <ul>
  <li class="toctree-l1 has-children">
  <span class="sidebar-brand-text">2.0.8</span>
  <input class="toctree-checkbox" id="toctree-checkbox-v" name="toctree-checkbox-v" role="switch" type="checkbox">
  <label for="toctree-checkbox-v"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label>
  <ul id="v-tags"></ul>
  </ul>
</div><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder=Search name="q" aria-label="Search">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../api.html">Library API (application program interface)</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="sdcflows.fieldmaps.html">sdcflows.fieldmaps module</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="sdcflows.interfaces.html">sdcflows.interfaces package</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="sdcflows.interfaces.brainmask.html">sdcflows.interfaces.brainmask module</a></li>
<li class="toctree-l3"><a class="reference internal" href="sdcflows.interfaces.bspline.html">sdcflows.interfaces.bspline module</a></li>
<li class="toctree-l3"><a class="reference internal" href="sdcflows.interfaces.epi.html">sdcflows.interfaces.epi module</a></li>
<li class="toctree-l3"><a class="reference internal" href="sdcflows.interfaces.fmap.html">sdcflows.interfaces.fmap module</a></li>
<li class="toctree-l3"><a class="reference internal" href="sdcflows.interfaces.reportlets.html">sdcflows.interfaces.reportlets module</a></li>
<li class="toctree-l3"><a class="reference internal" href="sdcflows.interfaces.utils.html">sdcflows.interfaces.utils module</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="sdcflows.transform.html">sdcflows.transform module</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="sdcflows.utils.html">sdcflows.utils package</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="sdcflows.utils.bimap.html">sdcflows.utils.bimap module</a></li>
<li class="toctree-l3"><a class="reference internal" href="sdcflows.utils.epimanip.html">sdcflows.utils.epimanip module</a></li>
<li class="toctree-l3"><a class="reference internal" href="sdcflows.utils.misc.html">sdcflows.utils.misc module</a></li>
<li class="toctree-l3"><a class="reference internal" href="sdcflows.utils.phasemanip.html">sdcflows.utils.phasemanip module</a></li>
<li class="toctree-l3"><a class="reference internal" href="sdcflows.utils.tools.html">sdcflows.utils.tools module</a></li>
<li class="toctree-l3"><a class="reference internal" href="sdcflows.utils.wrangler.html">sdcflows.utils.wrangler module</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="sdcflows.viz.html">sdcflows.viz package</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="sdcflows.viz.utils.html">sdcflows.viz.utils module</a></li>
</ul>
</li>
<li class="toctree-l2 current has-children"><a class="reference internal" href="sdcflows.workflows.html">sdcflows.workflows package</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l3 has-children"><a class="reference internal" href="sdcflows.workflows.apply.html">sdcflows.workflows.apply package</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="sdcflows.workflows.apply.correction.html">sdcflows.workflows.apply.correction module</a></li>
<li class="toctree-l4"><a class="reference internal" href="sdcflows.workflows.apply.registration.html">sdcflows.workflows.apply.registration module</a></li>
</ul>
</li>
<li class="toctree-l3 current has-children"><a class="reference internal" href="sdcflows.workflows.fit.html">sdcflows.workflows.fit package</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle child pages in navigation</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l4 current current-page"><a class="current reference internal" href="#">sdcflows.workflows.fit.fieldmap module</a></li>
<li class="toctree-l4"><a class="reference internal" href="sdcflows.workflows.fit.pepolar.html">sdcflows.workflows.fit.pepolar module</a></li>
<li class="toctree-l4"><a class="reference internal" href="sdcflows.workflows.fit.syn.html">sdcflows.workflows.fit.syn module</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="sdcflows.workflows.ancillary.html">sdcflows.workflows.ancillary module</a></li>
<li class="toctree-l3"><a class="reference internal" href="sdcflows.workflows.base.html">sdcflows.workflows.base module</a></li>
<li class="toctree-l3"><a class="reference internal" href="sdcflows.workflows.outputs.html">sdcflows.workflows.outputs module</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../changes.html">What’s new?</a></li>
</ul>

</div>
</div>
      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <div class="content-icon-container">
          <div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto"><use href="#svg-sun-half"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main">
          <section id="module-sdcflows.workflows.fit.fieldmap">
<span id="sdcflows-workflows-fit-fieldmap-module"></span><h1>sdcflows.workflows.fit.fieldmap module<a class="headerlink" href="#module-sdcflows.workflows.fit.fieldmap" title="Permalink to this headline">¶</a></h1>
<p>Processing phase-difference and <em>directly measured</em> <span class="math notranslate nohighlight">\(B_0\)</span> maps.</p>
<section id="theory">
<h2>Theory<a class="headerlink" href="#theory" title="Permalink to this headline">¶</a></h2>
<p>The displacement suffered by every voxel along the phase-encoding (PE) direction
can be derived from Eq. (2) of <a class="reference internal" href="#hutton2002" id="id1"><span>[Hutton2002]</span></a>:</p>
<div class="math-wrapper"><div class="math notranslate nohighlight">
\[\Delta_\text{PE} (i, j, k) = \gamma \cdot \Delta B_0 (i, j, k) \cdot T_\text{ro},
\label{eq:fieldmap-1}\tag{1}\]</div></div>
<p>where
<span class="math notranslate nohighlight">\(\Delta_\text{PE} (i, j, k)\)</span> is the <em>voxel-shift map</em> (VSM) along the <em>PE</em> direction,
<span class="math notranslate nohighlight">\(\gamma\)</span> is the gyromagnetic ratio of the H proton in Hz/T
(<span class="math notranslate nohighlight">\(\gamma = 42.576 \cdot 10^6 \, \text{Hz} \cdot \text{T}^\text{-1}\)</span>),
<span class="math notranslate nohighlight">\(\Delta B_0 (i, j, k)\)</span> is the <em>fieldmap variation</em> in T (Tesla), and
<span class="math notranslate nohighlight">\(T_\text{ro}\)</span> is the readout time of one slice of the EPI dataset
we want to correct for distortions.</p>
<p>Let <span class="math notranslate nohighlight">\(V\)</span> represent the «<em>fieldmap in Hz</em>» (or equivalently,
«<em>voxel-shift-velocity map</em>» as Hz are equivalent to voxels/s), with
<span class="math notranslate nohighlight">\(V(i,j,k) = \gamma \cdot \Delta B_0 (i, j, k)\)</span>, then, introducing
the voxel zoom along the phase-encoding direction, <span class="math notranslate nohighlight">\(s_\text{PE}\)</span>,
we obtain the nonzero component of the associated displacements field
<span class="math notranslate nohighlight">\(\Delta D_\text{PE} (i, j, k)\)</span> that unwarps the target EPI dataset:</p>
<div class="math-wrapper"><div class="math notranslate nohighlight">
\[\Delta D_\text{PE} (i, j, k) = V(i, j, k) \cdot T_\text{ro} \cdot s_\text{PE}.
\label{eq:fieldmap-2}\tag{2}\]</div></div>
</section>
<section id="direct-b0-mapping-sequences">
<span id="sdc-direct-b0"></span><h2>Direct B0 mapping sequences<a class="headerlink" href="#direct-b0-mapping-sequences" title="Permalink to this headline">¶</a></h2>
<p>Some MR schemes such as <abbr title="spiral-echo imaging">SEI</abbr> can directly
reconstruct an estimate of <em>the fieldmap in Hz</em>, <span class="math notranslate nohighlight">\(V(i,j,k)\)</span>.
These <em>fieldmaps</em> are described with more detail <a class="reference external" href="https://cni.stanford.edu/wiki/GE_Processing#Fieldmaps">here</a>.</p>
<p>This corresponds to <a class="reference external" href="https://bids-specification.readthedocs.io/en/latest/04-modality-specific-files/01-magnetic-resonance-imaging-data.html#case-3-direct-field-mapping">this section of the BIDS specification</a>.</p>
</section>
<section id="phase-difference-b0-estimation">
<span id="sdc-phasediff"></span><h2>Phase-difference B0 estimation<a class="headerlink" href="#phase-difference-b0-estimation" title="Permalink to this headline">¶</a></h2>
<p>The fieldmap variation in T, <span class="math notranslate nohighlight">\(\Delta B_0 (i, j, k)\)</span>, that is necessary to obtain
<span class="math notranslate nohighlight">\(\Delta_\text{PE} (i, j, k)\)</span> in Eq. <span class="math notranslate nohighlight">\(\eqref{eq:fieldmap-1}\)</span> can be
calculated from two subsequient <abbr title="Gradient-Recalled Echo">GRE</abbr> echoes,
via eq. (1) of <a class="reference internal" href="#hutton2002" id="id2"><span>[Hutton2002]</span></a>:</p>
<div class="math-wrapper"><div class="math notranslate nohighlight">
\[\Delta B_0 (i, j, k) = \frac{\Delta \Theta (i, j, k)}{2\pi \cdot \gamma \, \Delta\text{TE}},
\label{eq:fieldmap-3}\tag{3}\]</div></div>
<p>where
<span class="math notranslate nohighlight">\(\Delta \Theta (i, j, k)\)</span> is the phase-difference map in radians,
and <span class="math notranslate nohighlight">\(\Delta\text{TE}\)</span> is the elapsed time between the two GRE echoes.</p>
<p>For simplicity, the «<em>voxel-shift-velocity map</em>» <span class="math notranslate nohighlight">\(V(i,j,k)\)</span>, which we
can introduce in Eq. <span class="math notranslate nohighlight">\(\eqref{eq:fieldmap-2}\)</span> to directly obtain
the displacements field, can be obtained as:</p>
<div class="math-wrapper"><div class="math notranslate nohighlight">
\[V(i, j, k) = \frac{\Delta \Theta (i, j, k)}{2\pi \cdot \Delta\text{TE}}.
\label{eq:fieldmap-4}\tag{4}\]</div></div>
<p>This calculation is further complicated by the fact that <span class="math notranslate nohighlight">\(\Theta_i\)</span>
(and therefore, <span class="math notranslate nohighlight">\(\Delta \Theta\)</span>) are clipped (or <em>wrapped</em>) within
the range <span class="math notranslate nohighlight">\([0 \dotsb 2\pi )\)</span>.
It is necessary to find the integer number of offsets that make a region
continuously smooth with its neighbors (<em>phase-unwrapping</em>, <a class="reference internal" href="#jenkinson2003" id="id3"><span>[Jenkinson2003]</span></a>).</p>
<p>This corresponds to <a class="reference external" href="https://bids-specification.readthedocs.io/en/latest/04-modality-specific-files/01-magnetic-resonance-imaging-data.html#two-phase-images-and-two-magnitude-images">this section of the BIDS specification</a>.
Some scanners produce one <code class="docutils literal notranslate"><span class="pre">phasediff</span></code> map, where the drift between the two echos has
already been calculated (see <a class="reference external" href="https://bids-specification.readthedocs.io/en/latest/04-modality-specific-files/01-magnetic-resonance-imaging-data.html#case-1-phase-difference-map-and-at-least-one-magnitude-image">the corresponding section of BIDS</a>).</p>
<p class="rubric">References</p>
<dl class="citation">
<dt class="label" id="hutton2002"><span class="brackets">Hutton2002</span><span class="fn-backref">(<a href="#id1">1</a>,<a href="#id2">2</a>)</span></dt>
<dd><p>Hutton et al., Image Distortion Correction in fMRI: A Quantitative
Evaluation, NeuroImage 16(1):217-240, 2002. doi:<a class="reference external" href="https://doi.org/10.1006/nimg.2001.1054">10.1006/nimg.2001.1054</a>.</p>
</dd>
<dt class="label" id="jenkinson2003"><span class="brackets">Jenkinson2003</span><span class="fn-backref">(<a href="#id3">1</a>,<a href="#id4">2</a>)</span></dt>
<dd><p>Jenkinson, M. (2003) Fast, automated, N-dimensional phase-unwrapping
algorithm. MRM 49(1):193-197. doi:<a class="reference external" href="https://doi.org/10.1002/mrm.10354">10.1002/mrm.10354</a>.</p>
</dd>
</dl>
<dl class="py function">
<dt class="sig sig-object py" id="sdcflows.workflows.fit.fieldmap.init_fmap_wf">
<span class="sig-prename descclassname"><span class="pre">sdcflows.workflows.fit.fieldmap.</span></span><span class="sig-name descname"><span class="pre">init_fmap_wf</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">omp_nthreads</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">sloppy</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">debug</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mode</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'phasediff'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">name</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'fmap_wf'</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/sdcflows/workflows/fit/fieldmap.html#init_fmap_wf"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#sdcflows.workflows.fit.fieldmap.init_fmap_wf" title="Permalink to this definition">¶</a></dt>
<dd><p>Estimate the fieldmap based on a field-mapping MRI acquisition.</p>
<p>Estimates the fieldmap using either one phase-difference map or
image and one or more
magnitude images corresponding to two or more <abbr title="Gradient Echo sequence">GRE</abbr>
acquisitions.</p>
<p>When we have a sequence that directly measures the fieldmap,
we just need to mask it (using the corresponding magnitude image)
to remove the noise in the surrounding air region, and ensure that
units are Hz.</p>
<dl>
<dt>Workflow Graph</dt><dd><figure class="align-default">
<img alt="../_images/sdcflows-workflows-fit-fieldmap-1.png" src="../_images/sdcflows-workflows-fit-fieldmap-1.png"/>
</figure>
<p>(<a class="reference external" href="../api/sdcflows-workflows-fit-fieldmap-1.py">Source code</a>, <a class="reference external" href="../api/sdcflows-workflows-fit-fieldmap-1.png">png</a>, <a class="reference external" href="../api/sdcflows-workflows-fit-fieldmap-1.svg">svg</a>, <a class="reference external" href="../api/sdcflows-workflows-fit-fieldmap-1.pdf">pdf</a>)</p>
</dd>
</dl>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>omp_nthreads</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">int</span></code></a>) – Maximum number of threads an individual process may use.</p></li>
<li><p><strong>sloppy</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">bool</span></code></a>) – Whether a fast but less accurate correction should be applied.</p></li>
<li><p><strong>debug</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">bool</span></code></a>) – Run in debug mode</p></li>
<li><p><strong>name</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">str</span></code></a>) – Unique name of this workflow.</p></li>
</ul>
</dd>
<dt class="field-even">Inputs</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>magnitude</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#list" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">list</span></code></a> of <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">str</span></code></a>) – Path to the corresponding magnitude image for anatomical reference.</p></li>
<li><p><strong>fieldmap</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#list" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">list</span></code></a> of <code class="xref py py-obj docutils literal notranslate"><span class="pre">tuple`(:obj:`str</span></code>, <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">dict</span></code></a>)) – Path to the fieldmap acquisition (<code class="docutils literal notranslate"><span class="pre">*_fieldmap.nii[.gz]</span></code> of BIDS).</p></li>
</ul>
</dd>
<dt class="field-odd">Outputs</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>fmap</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">str</span></code></a>) – Path to the estimated fieldmap.</p></li>
<li><p><strong>fmap_ref</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">str</span></code></a>) – Path to a preprocessed magnitude image reference.</p></li>
<li><p><strong>fmap_coeff</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">str</span></code></a> or <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#list" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">list</span></code></a> of <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">str</span></code></a>) – The path(s) of the B-Spline coefficients supporting the fieldmap.</p></li>
<li><p><strong>fmap_mask</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">str</span></code></a>) – Path to a binary brain mask corresponding to the <code class="docutils literal notranslate"><span class="pre">fmap</span></code> and <code class="docutils literal notranslate"><span class="pre">fmap_ref</span></code>
pair.</p></li>
<li><p><strong>method</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">str</span></code></a>) – Short description of the estimation method that was run.</p></li>
</ul>
</dd>
</dl>
</dd></dl>
<dl class="py function">
<dt class="sig sig-object py" id="sdcflows.workflows.fit.fieldmap.init_magnitude_wf">
<span class="sig-prename descclassname"><span class="pre">sdcflows.workflows.fit.fieldmap.</span></span><span class="sig-name descname"><span class="pre">init_magnitude_wf</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">omp_nthreads</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">name</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'magnitude_wf'</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/sdcflows/workflows/fit/fieldmap.html#init_magnitude_wf"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#sdcflows.workflows.fit.fieldmap.init_magnitude_wf" title="Permalink to this definition">¶</a></dt>
<dd><p>Prepare the magnitude part of <abbr title="gradient-recalled echo">GRE</abbr> fieldmaps.</p>
<p>Average (if not done already) the magnitude part of the
<abbr title="gradient recalled echo">GRE</abbr> images, run N4 to
correct for B1 field nonuniformity, and skull-strip the
preprocessed magnitude.</p>
<dl>
<dt>Workflow Graph</dt><dd><figure class="align-default">
<img alt="../_images/sdcflows-workflows-fit-fieldmap-2.png" src="../_images/sdcflows-workflows-fit-fieldmap-2.png"/>
</figure>
<p>(<a class="reference external" href="../api/sdcflows-workflows-fit-fieldmap-2.py">Source code</a>, <a class="reference external" href="../api/sdcflows-workflows-fit-fieldmap-2.png">png</a>, <a class="reference external" href="../api/sdcflows-workflows-fit-fieldmap-2.svg">svg</a>, <a class="reference external" href="../api/sdcflows-workflows-fit-fieldmap-2.pdf">pdf</a>)</p>
</dd>
</dl>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>omp_nthreads</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">int</span></code></a>) – Maximum number of threads an individual process may use</p></li>
<li><p><strong>name</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">str</span></code></a>) – Name of workflow (default: <code class="docutils literal notranslate"><span class="pre">magnitude_wf</span></code>)</p></li>
</ul>
</dd>
<dt class="field-even">Inputs</dt>
<dd class="field-even"><p><strong>magnitude</strong> (<a class="reference external" href="https://docs.python.org/3/library/os.html#os.PathLike" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">os.PathLike</span></code></a>) – Path to the corresponding magnitude path(s).</p>
</dd>
<dt class="field-odd">Outputs</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>fmap_ref</strong> (<a class="reference external" href="https://docs.python.org/3/library/os.html#os.PathLike" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">os.PathLike</span></code></a>) – Path to the fieldmap reference calculated in this workflow.</p></li>
<li><p><strong>fmap_mask</strong> (<a class="reference external" href="https://docs.python.org/3/library/os.html#os.PathLike" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">os.PathLike</span></code></a>) – Path to a binary brain mask corresponding to the reference above.</p></li>
</ul>
</dd>
</dl>
</dd></dl>
<dl class="py function">
<dt class="sig sig-object py" id="sdcflows.workflows.fit.fieldmap.init_phdiff_wf">
<span class="sig-prename descclassname"><span class="pre">sdcflows.workflows.fit.fieldmap.</span></span><span class="sig-name descname"><span class="pre">init_phdiff_wf</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">omp_nthreads</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">debug</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">name</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'phdiff_wf'</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="../_modules/sdcflows/workflows/fit/fieldmap.html#init_phdiff_wf"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#sdcflows.workflows.fit.fieldmap.init_phdiff_wf" title="Permalink to this definition">¶</a></dt>
<dd><p>Generate a <span class="math notranslate nohighlight">\(B_0\)</span> field from consecutive-phases and phase-difference maps.</p>
<p>This workflow preprocess phase-difference maps (or generates the phase-difference
map should two <code class="docutils literal notranslate"><span class="pre">phase1</span></code>/<code class="docutils literal notranslate"><span class="pre">phase2</span></code> be provided at the input), and generates
an image equivalent to BIDS’s <code class="docutils literal notranslate"><span class="pre">fieldmap</span></code> that can be processed with the
general fieldmap workflow.</p>
<p>Besides phase2 - phase1 subtraction, the core of this particular workflow relies
in the phase-unwrapping with FSL PRELUDE <a class="reference internal" href="#jenkinson2003" id="id4"><span>[Jenkinson2003]</span></a>.
FSL PRELUDE takes wrapped maps in the range 0 to 6.28, <a class="reference external" href="https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FUGUE/Guide#Step_2_-_Getting_.28wrapped.29_phase_in_radians">as per the user guide</a>.</p>
<p>For the phase-difference maps, recentering back to <span class="math notranslate nohighlight">\([-\pi \dotsb \pi )\)</span>
is necessary.
After some massaging and with the scaling of the echo separation factor
<span class="math notranslate nohighlight">\(\Delta \text{TE}\)</span>, the phase-difference maps are converted into
an actual <span class="math notranslate nohighlight">\(B_0\)</span> map in Hz units.</p>
<dl>
<dt>Workflow Graph</dt><dd><figure class="align-default">
<img alt="../_images/sdcflows-workflows-fit-fieldmap-3.png" src="../_images/sdcflows-workflows-fit-fieldmap-3.png"/>
</figure>
<p>(<a class="reference external" href="../api/sdcflows-workflows-fit-fieldmap-3.py">Source code</a>, <a class="reference external" href="../api/sdcflows-workflows-fit-fieldmap-3.png">png</a>, <a class="reference external" href="../api/sdcflows-workflows-fit-fieldmap-3.svg">svg</a>, <a class="reference external" href="../api/sdcflows-workflows-fit-fieldmap-3.pdf">pdf</a>)</p>
</dd>
</dl>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>omp_nthreads</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#int" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">int</span></code></a>) – Maximum number of threads an individual process may use</p></li>
<li><p><strong>debug</strong> (<a class="reference external" href="https://docs.python.org/3/library/functions.html#bool" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">bool</span></code></a>) – Run in debug mode</p></li>
<li><p><strong>name</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#str" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">str</span></code></a>) – Name of workflow (default: <code class="docutils literal notranslate"><span class="pre">phdiff_wf</span></code>)</p></li>
</ul>
</dd>
<dt class="field-even">Inputs</dt>
<dd class="field-even"><ul class="simple">
<li><p><strong>magnitude</strong> (<a class="reference external" href="https://docs.python.org/3/library/os.html#os.PathLike" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">os.PathLike</span></code></a>) – A reference magnitude image preprocessed elsewhere.</p></li>
<li><p><strong>phase</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#list" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">list</span></code></a> of <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#tuple" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">tuple</span></code></a> of (<a class="reference external" href="https://docs.python.org/3/library/os.html#os.PathLike" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">os.PathLike</span></code></a>, <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#dict" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">dict</span></code></a>)) – List containing one GRE phase-difference map with its corresponding metadata
(requires <code class="docutils literal notranslate"><span class="pre">EchoTime1</span></code> and <code class="docutils literal notranslate"><span class="pre">EchoTime2</span></code>), or the phase maps for the two
subsequent echoes, with their metadata (requires <code class="docutils literal notranslate"><span class="pre">EchoTime</span></code>).</p></li>
<li><p><strong>mask</strong> (<a class="reference external" href="https://docs.python.org/3/library/os.html#os.PathLike" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">os.PathLike</span></code></a>) – A brain mask calculated from the magnitude image.</p></li>
</ul>
</dd>
<dt class="field-odd">Outputs</dt>
<dd class="field-odd"><p><strong>fieldmap</strong> (<a class="reference external" href="https://docs.python.org/3/library/os.html#os.PathLike" title="(in Python v3.10)"><code class="xref py py-obj docutils literal notranslate"><span class="pre">os.PathLike</span></code></a>) – The estimated fieldmap in Hz.</p>
</dd>
</dl>
</dd></dl>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="sdcflows.workflows.fit.pepolar.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">sdcflows.workflows.fit.pepolar module</div>
              </div>
              <svg><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="sdcflows.workflows.fit.html">
              <svg><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">sdcflows.workflows.fit package</div>
                
              </div>
            </a>
        </div>

        <div class="related-information">
              Copyright &#169; 2020, The NiPreps developers |
            Built with <a href="https://www.sphinx-doc.org/">Sphinx</a>
              and
              <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
              <a href="https://github.com/pradyunsg/furo">Furo theme</a>. |
            <a class="muted-link" href="../_sources/api/sdcflows.workflows.fit.fieldmap.rst.txt"
               rel="nofollow">
              Show Source
            </a>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            Contents
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">sdcflows.workflows.fit.fieldmap module</a><ul>
<li><a class="reference internal" href="#theory">Theory</a></li>
<li><a class="reference internal" href="#direct-b0-mapping-sequences">Direct B0 mapping sequences</a></li>
<li><a class="reference internal" href="#phase-difference-b0-estimation">Phase-difference B0 estimation</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/scripts/main.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/version-switch.js"></script>
    </body>
</html>